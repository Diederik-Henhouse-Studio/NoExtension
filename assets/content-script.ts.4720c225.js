const T=(t=100,e=999)=>(t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t);let p="";console.debug=()=>{};const G=()=>{console.debug("Looking for Reload...");let t=window.location.href;t!==p&&(console.debug("PAGE RELOADED",document.querySelector("title")),p=t,window.location.href.includes("https://www.linkedin.com/in/")||window.location.href.includes("https://twitter.com/")&&!window.location.href.includes("/status/")&&!window.location.href.includes("https://twitter.com/home")&&!window.location.href.includes("https://twitter.com/hashtag")&&!window.location.href.includes("https://twitter.com/explore")&&!window.location.href.includes("https://twitter.com/notifications")&&!window.location.href.includes("https://twitter.com/messages")&&!window.location.href.includes("https://twitter.com/i/bookmarks")&&!window.location.href.includes("https://twitter.com/search")?M():console.debug("PAGE RELOADED - NOT PROFILE PAGE")),console.debug("... URL hasn't changed")},H=async t=>{let e;try{console.groupCollapsed("Requesting search for contact",t),e=await chrome.runtime.sendMessage({url:t,id:T()}).then(o=>{if(console.log("Response received:",o),o.status==="OK")return console.log(o.status+": "+o.message,o.notion_url),o.notion_url}).catch(o=>console.log(o))}catch(o){console.log(o)}return console.groupEnd(),e||""},j=()=>{var t;if(console.debug("Looking for loaded..."),p=window.location.href,O=window.location.href.includes("https://www.linkedin.com")?document.querySelector(".artdeco-card .artdeco-button.pvs-profile-actions__action"):document.querySelector('main div[aria-label="Home timeline"]>div:not(:first-child) div[role="button"] span')){I.disconnect(),console.debug("BUTTONS LOADED",O);let e=document.URL.split("/").splice(0,5).join("/");window.location.href.includes("https://www.linkedin.com")&&(e=e+"/"),document.querySelector("#add2notion")&&((t=document.querySelector("#add2notion"))==null||t.remove(),console.debug("Removed previous button")),window.location.href.includes("https://twitter.com")?K():Y(),console.log("Searching in CRM ..."),H(e).then(o=>{o&&s("saved",o)}).catch(o=>{console.log(o)})}};function F(t){return new Promise(e=>setTimeout(e,t))}const h=async()=>{for(console.debug("Observing Reload");!document.querySelector("title");)console.debug("Waiting for <title> tag to load..."),await F(250);$.observe(document.querySelector("title"),{characterData:!0,childList:!0,subtree:!0})},M=()=>{console.debug("Observing Loaded"),I.observe(document,{subtree:!0,childList:!0})},$=new MutationObserver(G),I=new MutationObserver(j);let w,O;const J=chrome.runtime.getURL("extension-assets/button.html"),W=chrome.runtime.getURL("extension-assets/button_twitter.html"),m=chrome.runtime.getURL("extension-assets/notion_icon_64_64_no_bg.png"),B=chrome.runtime.getURL("extension-assets/spinner_64.png");function N(t){var e=new Image;e.src=t}let f;fetch(window.location.href.includes("https://twitter.com/")?W:J).then(t=>t.text()).then(t=>{N(m),N(B),w=t,!window.location.href.includes("https://www.linkedin.com/in/")&&!(window.location.href.includes("https://twitter.com/")&&!window.location.href.includes("/status/")&&!window.location.href.includes("https://twitter.com/home")&&!window.location.href.includes("https://twitter.com/hashtag")&&!window.location.href.includes("https://twitter.com/explore")&&!window.location.href.includes("https://twitter.com/notifications")&&!window.location.href.includes("https://twitter.com/messages")&&!window.location.href.includes("https://twitter.com/i/bookmarks")&&!window.location.href.includes("https://twitter.com/search"))?(console.debug("NOT PROFILE PAGE",window.location.href),h()):document.querySelector(".pvs-profile-actions")||document.querySelector('main div[aria-label="Home timeline"]>div:not(:first-child) div[role="button"] span')?(console.debug("PROFILE PAGE - Already loaded"),j(),h()):(console.debug("PROFILE PAGE - Waiting for page load..."),M(),h())});const P=()=>{var a,u,d,l,g;let t="",e="";try{t=((a=document.querySelector('[data-testid="UserUrl"] '))==null?void 0:a.href)||"",e=((u=document.querySelector('[data-testid="UserDescription"] '))==null?void 0:u.textContent)||""}catch(c){console.log("Couldn't find section Experience in profile",c)}const o="https://img.icons8.com/ios/250/000000/user.png";let n=(d=document.querySelector('[aria-label="Opens profile photo"] img'))==null?void 0:d.src;try{console.log("Checking picture URL");const c=new URL(n);if(console.log("Checking pictureUrlObject",c),!c.origin||c.origin==="null")throw console.log("Error thrown: Not valid pictureUrl, falling back to default icon"),Error("Not valid pictureUrl, falling back to default icon")}catch(c){console.log(c),n=o}let i="";try{i=((l=document.querySelector('[data-testid="UserLocation"]'))==null?void 0:l.textContent)||""}catch(c){console.log(c)}return{name:(g=document.querySelector('[data-testid="UserName"] div div div'))==null?void 0:g.textContent,bio:e.substring(0,2e3),bioUrl:t,location:i,profileUrl:window.location.href,pictureUrl:n}},A=()=>{var d,l,g,c,v,b,y,S,E,L,U,q,x,_,C,R,k;let t="",e="";try{(d=document.querySelector("#experience ~ div:nth-child(3) div div:nth-child(2)"))!=null&&d.querySelector('div a[data-field="experience_company_logo"]')?(t=((g=(l=document.querySelector("#experience ~ div:nth-child(3) div div:nth-child(2) div div span"))==null?void 0:l.textContent)==null?void 0:g.trim())||"",e=((c=document.querySelector("#experience ~ div:nth-child(3) div div:nth-child(2) .pvs-entity__sub-components div span"))==null?void 0:c.textContent)||""):(t=((b=(v=document.querySelector("#experience ~ div li div:nth-child(2) div div + span span"))==null?void 0:v.textContent)==null?void 0:b.trim())||"",e=((S=(y=document.querySelector("#experience ~ div li div:nth-child(2) div div div span"))==null?void 0:y.textContent)==null?void 0:S.trim())||"")}catch(r){console.log("Couldn't find section Experience in profile",r)}const o="https://img.icons8.com/ios/250/000000/user.png";let n=(E=document.querySelector(".pv-top-card__photo img"))==null?void 0:E.src;try{console.log("Checking picture URL");const r=new URL(n);if(console.log("Checking pictureUrlObject",r),!r.origin||r.origin==="null")throw console.log("Error thrown: Not valid pictureUrl, falling back to default icon"),Error("Not valid pictureUrl, falling back to default icon")}catch(r){console.log(r),n=o}let i="";try{i=((U=(L=document.querySelectorAll(".artdeco-card > div ")[1].children[1].children[2].querySelector("span"))==null?void 0:L.textContent)==null?void 0:U.trim())||""}catch(r){console.log(r)}let a="";try{a=((q=document.querySelector(".pv-top-card--website a"))==null?void 0:q.href)||""}catch(r){console.log(r)}let u="";try{u=((R=(C=(_=(x=document.querySelector("#about"))==null?void 0:x.parentElement)==null?void 0:_.querySelectorAll("span")[2])==null?void 0:C.textContent)==null?void 0:R.trim())||""}catch(r){console.log(r)}return{name:(k=document.querySelector("h1"))==null?void 0:k.innerHTML,jobTitle:e,company:t,location:i,profileUrl:window.location.href,pictureUrl:n,bioUrl:a,bio:u.substring(0,2e3)}},D=()=>{s("saving");let t;if(window.location.href.includes("https://twitter.com"))try{t=P(),console.log(t)}catch{setTimeout(()=>{t=P()},300)}else try{t=A()}catch{setTimeout(()=>{t=A()},300)}console.groupCollapsed("Sending current profile to background script...");try{return chrome.runtime.sendMessage({profile:t,id:T()}).then(e=>{console.log("Response received:",e),e.status==="OK"?(console.log(e.status+": "+e.message,e.page),s("saved","url"in e.page&&e.page.url)):e.status==="NotionError"||e.message==="Could not retrieve notion_api_token from storage"?(s("idle"),console.log(e.status+": "+e.message)):e.message.includes("free trial")?(s("idle"),console.log(e.status+": "+e.message),alert(`[peopletonotion]: ${e.message}`)):e.message.includes("is not a property that exists")?(s("idle"),console.warn(e.message),alert("[peopletonotion]: Can't find some of the target fields in Notion's database. Have you deleted them? Update the config and try again."),window.open(chrome.runtime.getURL("index.html"))):e.message.includes("Notion is not connected.")?(s("idle"),console.warn(e.message),alert(`[peopletonotion]: ${JSON.stringify(e.message)}. You're only one setp away from greatness.`),window.open(chrome.runtime.getURL("index.html#welcome"))):e.message.includes("PeopletoNotion is not configured.")?(s("idle"),console.warn(e.message),alert(`[peopletonotion]: ${JSON.stringify(e.message)}. You're only one setp away from greatness.`),window.open(chrome.runtime.getURL("index.html"))):e.message?(s("idle"),console.error(e.message),alert(`[peopletonotion]: ${JSON.stringify(e.message)} Reload the page and try again`)):(s("idle"),console.error(JSON.stringify(e)),alert(`[peopletonotion]: ${JSON.stringify(e)} Reload the page and try again`))}).then(()=>console.groupEnd()).catch(alert),t}catch(e){if(e instanceof Error)e.toString().includes("Extension context invalidated.")?alert(`[peopletonotion]: ${e.toString()} Reload the page and try again`):alert(e);else throw e;console.groupEnd()}},K=()=>{var t,e,o,n,i,a;if(document.querySelector("#add2notion"))console.debug("[peopletonotion] Button already loaded!");else{let d;console.debug("Injecting Button",!0),d=(i=(n=(o=(e=(t=Array.prototype.slice.call(document.querySelectorAll('main div[aria-label="Home timeline"]>div:not(:first-child) div[role="button"] span')).find(l=>l.textContent==="Follow"||l.textContent==="Following"))==null?void 0:t.parentElement)==null?void 0:e.parentElement)==null?void 0:o.parentElement)==null?void 0:n.parentElement)==null?void 0:i.parentElement,d?(console.debug("Injecting Button in",d),d.insertAdjacentHTML("beforeend",w),document.querySelector("#notion_icon").src=m,console.debug("Injected Button:",document.querySelector("#add2notion")),(a=document.querySelector("#add2notion"))==null||a.addEventListener("click",()=>{console.groupCollapsed("Getting current profile");try{D()}catch(l){if(console.debug(l),l instanceof Error)if(l.message==="Extension context invalidated")chrome.tabs.reload();else throw l;else throw l}console.groupEnd()}),f=document.querySelector("#add2notion")):console.log("[peopletonotion] Sorry, something went wrong.")}},Y=()=>{var t,e,o,n;document.querySelector("#add2notion")||(document.querySelector(".profile-topcard-background-image-edit__icon")?console.log("[peopletonotion] Sorry, it is not currently possible to save in Notion your own Linkedin Profile."):((o=(e=(t=document.querySelector(".artdeco-card .artdeco-button.pvs-profile-actions__action"))==null?void 0:t.parentElement)==null?void 0:e.parentElement)==null||o.insertAdjacentHTML("afterbegin",w),document.querySelector("#notion_icon").src=m,(n=document.querySelector("#add2notion"))==null||n.addEventListener("click",()=>{console.group("Getting current profile");try{D()}catch(i){if(i instanceof Error)if(i.message==="Extension context invalidated")chrome.tabs.reload();else throw i;else throw i}console.groupEnd()}),f=document.querySelector("#add2notion"),f||console.log("[peopletonotion]: Couldn't inject button")),console.log("[peopletonotion] Button already loaded!"))},s=(t,e)=>{console.debug("Setting button state",t,e);const o=document.querySelector("#add2notion");if(o){o.classList.remove("saved"),o.classList.remove("loading");const n=o.children;switch(n[0].src=m,n[0].style.filter="invert(100%)",n[0].classList.remove("animate-spin"),o.disabled=!1,t){case"idle":n[1].textContent="Add to Notion",n[0].style.filter="invert(100%)",o.disabled=!1;break;case"saving":n[0].src=B,n[1].textContent="Saving in Notion",o.classList.add("saved"),o.classList.add("loading"),n[0].style.filter="",o.disabled=!0,n[0].classList.add("animate-spin");break;case"saved":if(n[1].textContent="Saved in Notion",o.classList.add("saved"),n[0].style.filter="",e&&window){n[1].textContent="Open in Notion";const i=o.cloneNode(!0);o.replaceWith(i),i.addEventListener("click",()=>{var a;(a=window.open(e,"_blank"))==null||a.focus()})}break}}};
